name: Build and Push Docker Image

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取当前仓库代码 (包含你的 Dockerfile.main 和 starter.sh)
      - name: Checkout current repository
        uses: actions/checkout@v4

      # 2. 登录 Docker Hub (推送必须)
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 【注意】这里我们刻意没有使用 docker/setup-buildx-action 
      # 因为我们需要使用宿主机默认的 Docker 服务，这样第二步构建时才能直接使用第一步存在本地的 `openclaw:local`

      # 3. 从远程 Git 仓库拉取并构建 openclaw:local (不推送)
      - name: Build local image from remote repository
        uses: docker/build-push-action@v5
        with:
          context: .  # 直接使用远程仓库作为构建上下文
          push: false                                        # 不推送
          load: true                                         # 加载到本地 Docker 缓存
          tags: openclaw:local                               # 命名为 openclaw:local

      # 4. 使用当前仓库的 Dockerfile.main 构建并推送 main 标签
      - name: Build and Push main image
        uses: docker/build-push-action@v5
        with:
          context: .                                         # 使用当前仓库根目录
          file: ./Dockerfile.main                            # 指定你写的 Dockerfile.main
          push: true                                         # 推送到 Docker Hub
          # 请注意：这里替换了 DockerHub 用户名前缀，标准格式为 username/repository:tag
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/openclaw:main